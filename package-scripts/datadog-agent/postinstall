#!/bin/sh

LOG_DIR=/var/log/datadog
INSTALL_DIR=/opt/datadog-agent
CONFIG_DIR=$INSTALL_DIR/Datadog\ Agent.app/Contents/Resources
APP_CONF_DIR="/Applications/Datadog Agent.app/Contents/Resources"

# OS/Distro Detection
DISTRIBUTION=$(grep -Eo "(Debian|Ubuntu|RedHat|CentOS|openSUSE|Amazon)" /etc/issue 2>/dev/null || uname -s)

error_exit()
{
  echo "${PROGNAME}: ${1:-"Unknown Error"}" 1>&2
  exit 1
}


if [ $DISTRIBUTION = "Darwin" ]; then
  # Prepare log dir
  mkdir -p ${LOG_DIR} || error_exit "Cannot create ${LOG_DIR}!"
  chown -R root:admin $LOG_DIR
  chmod 775 $LOG_DIR
  touch $LOG_DIR/collector.log $LOG_DIR/forwarder.log $LOG_DIR/dogstatsd.log $LOG_DIR/supervisord.log
  chown root:admin $LOG_DIR/collector.log $LOG_DIR/forwarder.log $LOG_DIR/dogstatsd.log $LOG_DIR/supervisord.log
  chmod 664 $LOG_DIR/collector.log $LOG_DIR/forwarder.log $LOG_DIR/dogstatsd.log $LOG_DIR/supervisord.log

  sed "s|AGENT_BASE|$INSTALL_DIR|; s|USER_NAME|$(whoami)|" $INSTALL_DIR/Datadog\ Agent.app/Contents/Resources/com.datadoghq.Agent.plist.example > $INSTALL_DIR/Datadog\ Agent.app/Contents/Resources/com.datadoghq.Agent.plist


  # Copying existing conf is one exists
  if [ -e "$APP_CONF_DIR/datadog.conf" ]; then
    cp "$APP_CONF_DIR/datadog.conf" "$CONFIG_DIR/"
  # Or copying default
  else
    cp "$CONFIG_DIR/datadog.conf.example" "$CONFIG_DIR/datadog.conf"
  fi

  # Correct rights
  chown root:admin "$CONFIG_DIR/datadog.conf"
  chown -R root:admin "$CONFIG_DIR/datadog.conf" "$CONFIG_DIR/conf.d" "$CONFIG_DIR/checks.d"
  chmod 775 "$CONFIG_DIR/conf.d" "$CONFIG_DIR/checks.d"
  chmod 664 "$CONFIG_DIR/datadog.conf"
  chmod 664 "$CONFIG_DIR/datadog.conf.example" "$CONFIG_DIR/supervisor.conf" "$CONFIG_DIR/conf.d/"*


  # Installing the app
  rm -rf /Applications/Datadog\ Agent.app
  mv $INSTALL_DIR/Datadog\ Agent.app /Applications
fi
exit 0
